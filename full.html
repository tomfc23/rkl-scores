<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Karma League Scores Combined</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: #1a1a1a;
      color: #ffffff;
      min-height: 100vh;
      padding: 20px;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h2 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #ffffff;
    }
    
    .header h5 {
      font-size: 14px;
      font-weight: 400;
      color: #888;
    }
    
    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }
    
    .controls label {
      color: #ccc;
      font-size: 14px;
    }
    
    .controls select {
      background-color: #2a2a2a;
      color: #ffffff;
      border: 1px solid #444;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      min-width: 200px;
    }
    
    .controls button {
      background-color: #007acc;
      color: #ffffff;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    
    .controls button:hover:not(:disabled) {
      background-color: #0066b3;
    }
    
    .controls button:disabled {
      background-color: #444;
      cursor: not-allowed;
    }
    
    .game-list {
      max-width: 1200px;
      margin: 0 auto 40px;
    }
    
    .game-item {
      background-color: #2a2a2a;
      border-radius: 16px;
      margin-bottom: 12px;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.2s;
      border: 2px solid transparent;
    }
    
    .game-item:hover {
      background-color: #3a3a3a;
    }
    
    .game-item.selected {
      border-color: #007acc;
      background-color: #004a7f;
    }
    
    .team-name {
      font-size: 18px;
      font-weight: 600;
      color: #ffffff;
      flex: 1;
      white-space: nowrap;
    }
    
    .team-total {
      font-size: 18px;
      font-weight: 700;
      color: #4a90e2;
      width: 80px;
      text-align: right;
    }
    
    .game-container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: #2a2a2a;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    .scoreboard-header {
      background-color: #2a2a2a;
      padding: 30px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
    }
    
    .team-section {
      display: flex;
      align-items: center;
      flex: 1;
      gap: 20px;
    }
    
    .team-section.away {
      justify-content: flex-end;
    }
    
    .team-name-large {
      font-size: 28px;
      font-weight: 600;
      color: #ffffff;
      white-space: nowrap;
    }
    
    .team-logo {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #4a90e2, #357abd);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: #ffffff;
      flex-shrink: 0;
    }
    
    .team-logo.away {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
    }
    
    .score-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin: 0 40px;
      min-width: 150px;
    }
    
    .score-display {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .score {
      font-size: 48px;
      font-weight: 700;
      color: #ffffff;
      min-width: 50px;
      text-align: center;
    }
    
    .score-separator {
      font-size: 36px;
      color: #666;
      font-weight: 300;
    }
    
    .match-status {
      text-align: center;
    }
    
    .status-indicator {
      display: inline-block;
      width: 8px;
      height: 8px;
      background-color: #e74c3c;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-indicator.live {
      background-color: #27ae60;
    }
    
    .status-text {
      font-size: 14px;
      color: #888;
      font-weight: 500;
    }
    
    .match-events {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 40px;
      background-color: #333;
      border-top: 1px solid #444;
    }
    
    .event-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #ccc;
    }
    
    .event-icon {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background-color: #f39c12;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #000;
    }
    
    .event-icon.red-card {
      background-color: #e74c3c;
      color: #fff;
    }
    
    .team-details {
      padding: 24px;
    }
    
    .team-roster {
      margin-bottom: 32px;
    }
    
    .team-roster:last-child {
      margin-bottom: 0;
    }
    
    .roster-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #333;
    }
    
    .roster-team-name {
      font-size: 18px;
      font-weight: 600;
      color: #ffffff;
    }
    
    .roster-score {
      font-size: 18px;
      font-weight: 700;
      color: #4a90e2;
    }
    
    .roster-list {
      display: grid;
      gap: 8px;
    }
    
    .player-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background-color: #333;
      border-radius: 8px;
      transition: background-color 0.2s;
    }
    
    .player-row:hover {
      background-color: #3a3a3a;
    }
    
    .player-name {
      font-size: 14px;
      font-weight: 500;
      color: #ffffff;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .captain-badge {
      background-color: #f39c12;
      color: #000;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
    }
    
    .player-score {
      font-size: 14px;
      font-weight: 600;
    }
    
    .positive-score {
      color: #27ae60;
    }
    
    .negative-score {
      color: #e74c3c;
    }
    
    .neutral-score {
      color: #95a5a6;
    }
    
    .captain-boost {
      color: #f39c12;
      font-size: 12px;
      margin-left: 4px;
    }
    
    .actions {
      text-align: center;
      padding: 20px;
      border-top: 1px solid #333;
    }
    
    .refresh-btn {
      background-color: #27ae60;
      color: #ffffff;
      border: none;
      border-radius: 8px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .refresh-btn:hover:not(:disabled) {
      background-color: #219a52;
      transform: translateY(-1px);
    }
    
    .refresh-btn:disabled {
      background-color: #444;
      cursor: not-allowed;
      transform: none;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #888;
      font-size: 16px;
    }
    
    .error {
      text-align: center;
      padding: 40px;
      color: #e74c3c;
      font-size: 16px;
    }
    
    @media (max-width: 768px) {
      .scoreboard-header {
        flex-direction: column;
        gap: 20px;
        text-align: center;
        padding: 20px;
      }
      
      .team-section {
        justify-content: center;
        flex-direction: row;
      }
      
      .team-section.away {
        justify-content: center;
        flex-direction: row;
      }
      
      .score-section {
        margin: 0;
      }
      
      .team-name-large {
        font-size: 20px;
      }
      
      .score {
        font-size: 36px;
      }
      
      .match-events {
        flex-direction: column;
        gap: 10px;
        padding: 15px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>Karma League Scores</h2>
    <h5>Click a game below or select from the dropdown to see full breakdown</h5>
  </div>

  <div class="game-list" id="game-list">
    Loading games...
  </div>

  <div class="controls" style="max-width: 1200px; margin: 0 auto 40px;">
    <label for="game-select">Select a game:</label>
    <select id="game-select"><option>Loading...</option></select>
    <button id="load-game-btn" disabled>Load Game</button>
  </div>

  <div id="game-output" style="max-width: 1200px; margin: 0 auto;"></div>

  <script>
    const scheduleCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRgy7uZ8caLI4hTPKSjl9e7ztFaM9vdBk4vXDQbPtcybqzXGOm3FMpSJiyrRTzIM3K70z_6XbgBGP_0/pub?output=csv';
    const rosterCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRe5WoA--wsfCCCvtL8QgQKsJv0z1AIUTY7k5NEYgUF-Ipu3Iotxkcbw7D-Cme6YGUksHy3DmyDYpaO/pub?output=csv';

    let todaysGames = [];
    let allPlayers = [];
    let selectedGameIndex = null;
    let refreshCooldown = false;

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      return lines.slice(1).map(line => {
        const parts = line.split(',').map(p => p.trim());
        const obj = {};
        headers.forEach((h, i) => {
          obj[h] = parts[i];
        });
        return obj;
      });
    }

    function getTodayString() {
      const now = new Date();
      const estTime = new Date(
        now.toLocaleString("en-US", { timeZone: "America/New_York" })
      );
      if (estTime.getHours() < 7) estTime.setDate(estTime.getDate() - 1);
      const month = estTime.getMonth() + 1;
      const day = estTime.getDate();
      return `${month}/${day}`;
    }

    async function fetchKarma(userId) {
      const apiUrl = `https://api.real.vg/user/${userId}/karmafeed`;
      const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(apiUrl)}`;
      try {
        const response = await axios.get(proxyUrl);
        const data = JSON.parse(response.data.contents);
        const delta = data?.stats?.karmaDelta;
        return typeof delta === 'number' ? delta : Number(delta) || 0;
      } catch (e) {
        console.error(`Error fetching karma for ${userId}:`, e);
        return null;
      }
    }

    async function processRoster(players) {
      let teamScore = 0;
      const lines = [];

      for (const p of players) {
        const userId = p['User ID']?.trim();
        const userAt = p['User @']?.trim() || 'Unknown';

        if (!userId || userId.toLowerCase() === 'not found') {
          lines.push(`${userAt}: missing user ID`);
          continue;
        }

        const karma = await fetchKarma(userId);
        if (karma === null) {
          lines.push(`${userAt}: error fetching`);
          continue;
        }

        const deduction = parseFloat(p['deductions'] || 0);
        const adjusted = karma - deduction;
        const role = (p['role'] || '').trim().toLowerCase();
        const isCaptain = role === 'captain';
        const boosted = isCaptain ? adjusted * 1.5 : adjusted;

        teamScore += boosted;

        const adjRounded = Math.round(adjusted);
        const boostRounded = Math.round(boosted);
        const label = `${userAt}${isCaptain ? ' (c)' : ''}`;

        const formatted = isCaptain
          ? `${label}: <span class="${adjRounded < 0 ? 'negative-score' : 'positive-score'}">${adjRounded}</span> → <span class="${boostRounded < 0 ? 'negative-score' : 'positive-score'}">${boostRounded}</span>`
          : `${label}: <span class="${adjRounded < 0 ? 'negative-score' : 'positive-score'}">${adjRounded}</span>`;

        lines.push(formatted);
      }

      return { lines, total: Math.round(teamScore) };
    }

    // Get team total by summing all players (without showing player lines)
    async function getTeamTotal(teamName) {
      const players = allPlayers.filter(p => p.Team === teamName && p['playing?']?.toLowerCase() === 'yes');
      let total = 0;
      for (const p of players) {
        const userId = p['User ID']?.trim();
        if (!userId || userId.toLowerCase() === 'not found') continue;
        const karma = await fetchKarma(userId);
        if (karma === null) continue;
        const deduction = parseFloat(p['deductions'] || 0);
        const adjusted = karma - deduction;
        const role = (p['role'] || '').trim().toLowerCase();
        const boosted = role === 'captain' ? adjusted * 1.5 : adjusted;
        total += boosted;
      }
      return Math.round(total);
    }

    async function renderGameList() {
      const container = document.getElementById('game-list');
      container.innerHTML = '<div class="loading">Loading team totals...</div>';
      if (todaysGames.length === 0) {
        container.innerHTML = '<div class="error">No games scheduled for today.</div>';
        return;
      }

      // Clear container
      container.innerHTML = '';

      // For each game, fetch totals for both teams (in parallel)
      for (let i = 0; i < todaysGames.length; i++) {
        const game = todaysGames[i];
        const team1 = game['Team 1'];
        const team2 = game['Team 2'];

        // We can fetch both team totals concurrently
        // Show "Loading..." initially
        const gameItem = document.createElement('div');
        gameItem.className = 'game-item';
        gameItem.dataset.index = i;
        gameItem.innerHTML = `
          <div class="team-name">${team1}</div>
          <div class="team-total">...</div>
          <div class="team-name" style="text-align:right;">${team2}</div>
          <div class="team-total" style="width:80px; text-align:right;">...</div>
        `;
        container.appendChild(gameItem);
      }

      // Fetch and update totals
      const gameItems = [...container.querySelectorAll('.game-item')];
      for (const gameItem of gameItems) {
        const idx = parseInt(gameItem.dataset.index, 10);
        const game = todaysGames[idx];
        const team1 = game['Team 1'];
        const team2 = game['Team 2'];

        const [total1, total2] = await Promise.all([
          getTeamTotal(team1),
          getTeamTotal(team2)
        ]);

        // Update UI - team totals (first team total is second child, second team total is fourth child)
        gameItem.children[1].textContent = total1;
        gameItem.children[3].textContent = total2;
      }

      // Add click handlers
      container.querySelectorAll('.game-item').forEach(div => {
        div.addEventListener('click', () => {
          // Clear all selected
          container.querySelectorAll('.game-item.selected').forEach(el => el.classList.remove('selected'));
          div.classList.add('selected');
          selectedGameIndex = parseInt(div.dataset.index, 10);
          // Enable Load Game button
          document.getElementById('load-game-btn').disabled = false;
          // Sync dropdown selection
          document.getElementById('game-select').value = selectedGameIndex;
        });
      });

      // Populate dropdown select
      const select = document.getElementById('game-select');
      select.innerHTML = '';
      todaysGames.forEach((g, i) => {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = `${g['Team 1']} vs ${g['Team 2']}`;
        select.appendChild(option);
      });
      // When dropdown changes
      select.addEventListener('change', () => {
        selectedGameIndex = parseInt(select.value, 10);
        // Highlight corresponding game-item in list
        container.querySelectorAll('.game-item').forEach(el => el.classList.remove('selected'));
        const selectedDiv = container.querySelector(`.game-item[data-index="${selectedGameIndex}"]`);
        if (selectedDiv) selectedDiv.classList.add('selected');
        document.getElementById('load-game-btn').disabled = false;
      });
    }

    async function loadAndRenderFullGame(index) {
      if (refreshCooldown) return; // Prevent rapid refresh

      if (index == null || index < 0 || index >= todaysGames.length) {
        alert('Invalid game selected.');
        return;
      }

      refreshCooldown = true;
      document.getElementById('load-game-btn').disabled = true;
      document.getElementById('load-game-btn').textContent = 'Loading...';

      const game = todaysGames[index];
      const team1 = game['Team 1'];
      const team2 = game['Team 2'];

      // Filter players per team who are playing
      const team1Players = allPlayers.filter(p => p.Team === team1 && p['playing?']?.toLowerCase() === 'yes');
      const team2Players = allPlayers.filter(p => p.Team === team2 && p['playing?']?.toLowerCase() === 'yes');

      // Process players for karma
      const [team1Processed, team2Processed] = await Promise.all([
        processRoster(team1Players),
        processRoster(team2Players)
      ]);

      // Build HTML output
      const outputDiv = document.getElementById('game-output');
      outputDiv.innerHTML = `
      <div class="game-container">
        <div class="scoreboard-header" style="display: flex; justify-content: center; align-items: center; gap: 12px; font-size: 24px; font-weight: 700; color: #ffffff; flex-wrap: wrap;">
  <div class="team-name-large" style="white-space: nowrap;">${team1}</div>
  <div style="color: #4a90e2;">${team1Processed.total}</div>
  <div style="color: #888; user-select: none;">-</div>
  <div style="color: #4a90e2;">${team2Processed.total}</div>
  <div class="team-name-large" style="white-space: nowrap;">${team2}</div>
</div>


        <div class="match-events">
          <div class="event-item"><div class="event-icon">⚽</div> Goals: 2 - 1</div>
          <div class="event-item"><div class="event-icon red-card">🟥</div> Red Cards: 1 - 0</div>
        </div>

        <div class="team-details">
          <div class="team-roster">
            <div class="roster-header">
              <div class="roster-team-name">${team1}</div>
              <div class="roster-score">${team1Processed.total}</div>
            </div>
            <div class="roster-list">
              ${team1Processed.lines.map(line => `<div class="player-row"><div class="player-name">${line}</div></div>`).join('')}
            </div>
          </div>

          <div class="team-roster">
            <div class="roster-header">
              <div class="roster-team-name">${team2}</div>
              <div class="roster-score">${team2Processed.total}</div>
            </div>
            <div class="roster-list">
              ${team2Processed.lines.map(line => `<div class="player-row"><div class="player-name">${line}</div></div>`).join('')}
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="refresh-btn" id="refresh-btn">Refresh Scores</button>
        </div>
      </div>`;

      // Setup refresh button cooldown
      const refreshBtn = document.getElementById('refresh-btn');
      refreshBtn.disabled = true; // disable for 5 sec initially
      setTimeout(() => { refreshBtn.disabled = false; }, 5000);

      refreshBtn.onclick = async () => {
        if (refreshBtn.disabled) return;
        refreshBtn.disabled = true;
        refreshBtn.textContent = 'Refreshing...';
        await loadAndRenderFullGame(index);
        setTimeout(() => {
          refreshBtn.disabled = false;
          refreshBtn.textContent = 'Refresh Scores';
        }, 5000);
      };

      document.getElementById('load-game-btn').disabled = false;
      document.getElementById('load-game-btn').textContent = 'Load Game';

      refreshCooldown = false;
    }

    async function loadData() {
      try {
        // Fetch schedule CSV
        const scheduleResponse = await axios.get(scheduleCsvUrl);
        const scheduleText = scheduleResponse.data;
        const scheduleData = parseCSV(scheduleText);

        // Filter today's games by date with EST timezone adjustment and 7am cutoff
        const today = getTodayString();
        todaysGames = scheduleData.filter(g => g.Date === today);

        // Fetch roster CSV
        const rosterResponse = await axios.get(rosterCsvUrl);
        const rosterText = rosterResponse.data;
        allPlayers = parseCSV(rosterText);

        // Render the list with team totals
        await renderGameList();

      } catch (e) {
        console.error(e);
        document.getElementById('game-list').innerHTML = '<div class="error">Error loading data.</div>';
      }
    }

    // Load game button handler
    document.getElementById('load-game-btn').addEventListener('click', () => {
      if (selectedGameIndex != null) {
        loadAndRenderFullGame(selectedGameIndex);
      }
    });

    loadData();
  </script>
</body>
</html>
