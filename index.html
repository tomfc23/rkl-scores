<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Karma League Scores</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .game-container {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 20px;
    }
    .team {
      margin: 10px 0;
    }
    .team-name {
      font-weight: bold;
      font-size: 1.1em;
    }
    .roster {
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h2>Karma League - Today's Matchups 2.0</h2>
  <button onclick="loadKarmaLeague()">Refresh League</button>
  <div id="games"></div>

  <script>
    const scheduleUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRgy7uZ8caLI4hTPKSjl9e7ztFaM9vdBk4vXDQbPtcybqzXGOm3FMpSJiyrRTzIM3K70z_6XbgBGP_0/pub?output=csv';
    const rosterUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRe5WoA--wsfCCCvtL8QgQKsJv0z1AIUTY7k5NEYgUF-Ipu3Iotxkcbw7D-Cme6YGUksHy3DmyDYpaO/pub?output=csv';

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      return lines.slice(1).map(line => {
        const parts = line.split(',').map(p => p.trim());
        let obj = {};
        headers.forEach((h, i) => {
          obj[h] = parts[i] || '';
        });
        return obj;
      });
    }

    async function fetchKarma(userId) {
      const apiUrl = `https://api.real.vg/user/${userId}/karmafeed`;
      const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(apiUrl)}`;
      try {
        const response = await axios.get(proxyUrl);
        const data = JSON.parse(response.data.contents);
        return data.stats.karmaDelta || 0;
      } catch (e) {
        console.error(`Error fetching karma for ${userId}`, e);
        return null;
      }
    }

    async function loadKarmaLeague() {
      const gamesDiv = document.getElementById('games');
      gamesDiv.innerHTML = 'Loading...';

      try {
        const [scheduleRes, rosterRes] = await Promise.all([
          axios.get(scheduleUrl),
          axios.get(rosterUrl)
        ]);

        const schedule = parseCSV(scheduleRes.data);
        const rosters = parseCSV(rosterRes.data);

        const today = new Date().toLocaleDateString('en-US', { timeZone: 'America/New_York' });

        // Filter today's games
        const todayGames = schedule.filter(g => g['Date'].trim() === today);

        if (todayGames.length === 0) {
          gamesDiv.innerHTML = 'No games scheduled for today.';
          return;
        }

        gamesDiv.innerHTML = '';

        for (const game of todayGames) {
          const team1 = game['Team 1'].trim();
          const team2 = game['Team 2'].trim();

          const gameContainer = document.createElement('div');
          gameContainer.className = 'game-container';

          const team1Div = document.createElement('div');
          team1Div.className = 'team';
          const team1Name = document.createElement('div');
          team1Name.className = 'team-name';
          team1Name.innerText = `${team1}`;
          const team1Roster = document.createElement('div');
          team1Roster.className = 'roster';
          team1Roster.innerText = 'Loading roster...';

          const team2Div = document.createElement('div');
          team2Div.className = 'team';
          const team2Name = document.createElement('div');
          team2Name.className = 'team-name';
          team2Name.innerText = `${team2}`;
          const team2Roster = document.createElement('div');
          team2Roster.className = 'roster';
          team2Roster.innerText = 'Loading roster...';

          team1Div.appendChild(team1Name);
          team1Div.appendChild(team1Roster);
          team2Div.appendChild(team2Name);
          team2Div.appendChild(team2Roster);
          gameContainer.appendChild(team1Div);
          gameContainer.appendChild(team2Div);
          gamesDiv.appendChild(gameContainer);

          loadTeamRoster(team1, rosters, team1Roster);
          loadTeamRoster(team2, rosters, team2Roster);
        }
      } catch (e) {
        gamesDiv.innerText = 'Error loading schedule or rosters.';
        console.error(e);
      }
    }

    async function loadTeamRoster(teamName, rosterData, container) {
      const players = rosterData.filter(player =>
        player['Team'].trim() === teamName &&
        player['playing?'].trim().toLowerCase() === 'yes' &&
        player['User ID'].trim() !== '' &&
        player['User ID'].trim().toLowerCase() !== 'not found'
      );

      const rosterLines = [];

      for (const player of players) {
        const userId = player['User ID'].trim();
        const userAt = player['User @'].trim();
        const role = (player['role'] || '').trim().toLowerCase();
        const deduction = parseInt(player['deductions'] || '0');

        const karma = await fetchKarma(userId);
        if (karma === null) {
          rosterLines.push(`${userAt}: error`);
        } else {
          const score = karma - deduction;
          const cap = role === 'captain' ? ' (c)' : '';
          rosterLines.push(`${userAt}${cap}: ${score}`);
        }
      }

      container.innerText = rosterLines.length ? rosterLines.join('\n') : 'No active players';
    }

    loadKarmaLeague();
  </script>
</body>
</html>
